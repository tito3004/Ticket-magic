{
  "version": 3,
  "sources": ["src/app/services/auth.service.ts"],
  "sourcesContent": ["// Servicio de autenticación: login, verificación/restauración con token y manejo de rol/estado\r\nimport { Injectable } from '@angular/core';\r\nimport { HttpClient, HttpHeaders } from '@angular/common/http';\r\nimport { BehaviorSubject, Observable, of, tap, catchError } from 'rxjs';\r\nimport { environment } from 'src/environments/environment';\r\nexport interface ApiResponse {\r\n  status: boolean;\r\n  message: string;\r\n  value?: any;\r\n  usuario?: any;\r\n  token?: string | string[];  \r\n  rol?: boolean;              \r\n}\r\n\r\n@Injectable({ providedIn: 'root' })\r\nexport class AuthService {\r\n  // Config base de API y headers\r\n  private url = `${environment.apiurl}auth`;\r\n  private headers = new HttpHeaders({ 'Content-Type': 'application/json; charset=utf-8' });\r\n\r\n  // Estado reactivo del rol (admin|user|null)\r\n  private rol$ = new BehaviorSubject<boolean | null>(null);\r\n\r\n  // Claves de storage\r\n  private tokenKey = 'token';\r\n  private roleKey  = 'is_admin';\r\n\r\n  // ---- Helpers de token (get/set en localStorage) ----\r\n  get token(): string | null { return localStorage.getItem(this.tokenKey); }\r\n  set token(v: string | null) {\r\n    if (v) localStorage.setItem(this.tokenKey, v);\r\n    else   localStorage.removeItem(this.tokenKey);\r\n  }\r\n\r\n  // Normaliza token a string \"xxx.yyy.zzz\"\r\n  private normalizeToken(raw: unknown): string | null {\r\n    if (!raw) return null;\r\n    if (typeof raw === 'string') return raw;\r\n    if (Array.isArray(raw) && raw.every(p => typeof p === 'string')) {\r\n      return (raw as string[]).join('.');\r\n    }\r\n    // Intenta recuperar si vino como objeto/JSON\r\n    if (typeof raw === 'object') {\r\n      try {\r\n        const maybe = JSON.parse(JSON.stringify(raw));\r\n        if (Array.isArray(maybe)) return maybe.join('.');\r\n        if (typeof maybe === 'string') return maybe;\r\n      } catch {}\r\n    }\r\n    return null;\r\n  }\r\n\r\n  // ---- Helpers de rol (BehaviorSubject + localStorage) ----\r\n  get isAdmin$(): Observable<boolean | null> { return this.rol$.asObservable(); }\r\n  get isAdmin(): boolean | null { return this.rol$.value; }\r\n\r\n  private seedRoleFromStorage(): boolean | null {\r\n    const raw = localStorage.getItem(this.roleKey);\r\n    if (raw === null) return null;\r\n    const val = raw.toLowerCase() === 'true';\r\n    this.rol$.next(val);\r\n    return val;\r\n  }\r\n\r\n  // Asegura que el rol esté sembrado desde storage cuando sea necesario\r\n  ensureRole$(): Observable<boolean | null> {\r\n    if (this.rol$.value !== null) return of(this.rol$.value);\r\n    const seeded = this.seedRoleFromStorage();\r\n    return of(seeded);\r\n  }\r\n\r\n  // ---- Llamadas a la API ----\r\n\r\n  // Login: guarda token normalizado y rol en storage/estado\r\n  login(datos: any): Observable<ApiResponse> {\r\n    return this.http\r\n      .post<ApiResponse>(`${this.url}/login`, datos, { headers: this.headers })\r\n      .pipe(\r\n        tap(res => {\r\n          const norm = this.normalizeToken(res?.token);\r\n          if (norm) this.token = norm;\r\n\r\n          if (typeof res?.rol === 'boolean') {\r\n            this.rol$.next(res.rol);\r\n            localStorage.setItem(this.roleKey, String(res.rol));\r\n          } else {\r\n            this.rol$.next(null);\r\n            localStorage.removeItem(this.roleKey);\r\n          }\r\n        }),\r\n        catchError(err => {\r\n          console.error('Error al iniciar sesión:', err);\r\n          const backendMessage = err?.error?.message ?? 'Error desconocido';\r\n          return of({ status: false, message: backendMessage } as ApiResponse);\r\n        })\r\n      );\r\n  }\r\n\r\n  // Logout: limpia token y rol\r\n  logout(): void {\r\n    this.token = null;\r\n    this.rol$.next(null);\r\n    localStorage.removeItem(this.roleKey);\r\n  }\r\n\r\n  // Verifica validez de un token (GET)\r\n  verificarToken(token: string): Observable<ApiResponse> {\r\n    return this.http\r\n      .get<ApiResponse>(`${this.url}/verificar?token=${token}`)\r\n      .pipe(\r\n        catchError(error => {\r\n          console.error('Error al verificar el token:', error);\r\n          const backendMessage = error?.error?.message || 'Error desconocido';\r\n          return of({ status: false, message: backendMessage } as ApiResponse);\r\n        })\r\n      );\r\n  }\r\n\r\n  // Restaurar contraseña con token (POST)\r\n  recuperando(token: string, datos: any): Observable<ApiResponse> {\r\n    return this.http\r\n      .post<ApiResponse>(`${this.url}/restaurar?token=${token}`, datos, { headers: this.headers })\r\n      .pipe(\r\n        catchError(error => {\r\n          console.error('Error al restaurar:', error);\r\n          const backendMessage = error?.error?.message || 'Error desconocido';\r\n          return of({ status: false, message: backendMessage } as ApiResponse);\r\n        })\r\n      );\r\n  }\r\n\r\n  // Inyección de HttpClient\r\n  constructor(private http: HttpClient) {}\r\n}\r\n"],
  "mappings": "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",
  "names": []
}
